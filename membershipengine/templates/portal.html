<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Membership management portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui;padding:22px;background:#f6f7fb;color:#111827}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:16px;padding:16px;max-width:1100px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    input,select,button{height:42px;border-radius:12px;border:1px solid #e6e8ef;padding:0 12px;font-size:14px}
    button{cursor:pointer;background:#111827;color:#fff;border:0}
    button.secondary{background:#fff;color:#111827;border:1px solid #e6e8ef}
    button.danger{background:#991b1b}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eef0f6;padding:10px;text-align:left;font-size:14px;vertical-align:middle}
    th{color:#6b7280;font-weight:650}
    .muted{color:#6b7280}
    .status{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas;font-size:12px;margin-top:10px}
    a{color:#111827}
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:750;font-size:18px;">Membership management portal</div>
        <div class="muted" style="margin-top:4px;">Loading queue items on open.</div>
      </div>
      <div class="row">
        <button class="secondary" id="refreshBtn" type="button">Refresh</button>
        <a class="secondary" href="/membershipengine/" style="display:inline-flex;align-items:center;height:42px;padding:0 12px;border-radius:12px;border:1px solid #e6e8ef;text-decoration:none;">← Back</a>
      </div>
    </div>

    <div id="tableWrap"></div>
    <div id="statusBox" class="status"></div>
  </div>

  <script>
    const tableWrap = document.getElementById("tableWrap");
    const statusBox = document.getElementById("statusBox");
    const refreshBtn = document.getElementById("refreshBtn");

    function setStatus(msg) {
      statusBox.textContent = msg || "";
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      })[s]);
    }

    function render(items) {
      if (!items || items.length === 0) {
        tableWrap.innerHTML = `<div class="muted" style="margin-top:10px;">No items found.</div>`;
        return;
      }

      const rows = items.map((x) => `
        <tr>
          <td>
            <div style="font-weight:650;">${escapeHtml(x.customerName || "-")}</div>
            <div class="muted">${escapeHtml(x.email || "")}</div>
          </td>
          <td>${escapeHtml(x.startDate || "-")}</td>
          <td>${escapeHtml(x.endDate || "-")}</td>
          <td>${escapeHtml(x.status || "-")}</td>
          <td style="white-space:nowrap; display:flex; gap:8px; flex-wrap:wrap;">
            ${x.customerUrl ? `<a href="${x.customerUrl}" target="_blank" rel="noopener noreferrer">Customer</a>` : ""}
            ${x.reservationUrl ? `<a href="${x.reservationUrl}" target="_blank" rel="noopener noreferrer">Reservation</a>` : ""}
            ${x.reservationId ? `<button type="button" class="secondary" onclick="extendMembership('${x.reservationId}')">Extend</button>` : ""}
            ${x.reservationId ? `<button type="button" class="danger" onclick="cancelMembership('${x.reservationId}')">Cancel</button>` : ""}
          </td>
        </tr>
      `).join("");

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Customer</th>
              <th>Start</th>
              <th>End</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    async function loadList() {
      setStatus("Loading...");
      tableWrap.innerHTML = "";
      const res = await fetch("/membershipengine/api/portal/list");
      const data = await res.json();

      if (!res.ok) {
        setStatus("Error:\n" + JSON.stringify(data, null, 2));
        return;
      }

      render(data.items || []);
      setStatus("");
    }

    async function extendMembership(reservationId) {
      const extraMonths = Number(prompt("Extend by how many months? (1-12)", "1"));
      if (!extraMonths) return;

      setStatus("Extending...");
      const res = await fetch("/membershipengine/api/portal/extend", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ reservationId, extraMonths })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setStatus("Extend error:\n" + JSON.stringify(data, null, 2));
        return;
      }
      setStatus("Extended.\n" + JSON.stringify(data, null, 2));
      await loadList();
    }

    async function cancelMembership(reservationId) {
      const reason = prompt("Reason (optional):", "");
      if (!confirm("Are you sure you want to cancel this membership?")) return;

      setStatus("Cancelling...");
      const res = await fetch("/membershipengine/api/portal/cancel", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ reservationId, reason })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setStatus("Cancel error:\n" + JSON.stringify(data, null, 2));
        return;
      }
      setStatus("Cancelled.\n" + JSON.stringify(data, null, 2));
      await loadList();
    }

    refreshBtn.addEventListener("click", loadList);
    window.extendMembership = extendMembership;
    window.cancelMembership = cancelMembership;

    // ✅ on open
    document.addEventListener("DOMContentLoaded", loadList);
  </script>
</body>
</html>